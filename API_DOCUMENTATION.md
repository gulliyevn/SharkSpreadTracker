# API Документация - Как должно работать

## WebSocket Endpoint: `/socket/sharkStraight`

### Основная информация

- **URL:** `ws://158.220.122.153:8080/socket/sharkStraight` (или `http://` для handshake)
- **Метод:** GET (для WebSocket handshake)
- **Тип:** WebSocket (не persistent)

### Поведение WebSocket

**ВАЖНО:** Это НЕ persistent WebSocket соединение!

1. Клиент устанавливает WebSocket соединение
2. Сервер **сразу** отправляет полный список спредов (JSON массив)
3. После отправки данных сервер **закрывает соединение**
4. Для получения новых данных нужно **переподключаться**

**Вывод:** Текущая реализация, где WebSocket используется как request-response, **правильная**! Это не real-time поток, а одноразовая отправка данных.

### Query Parameters

#### `token` (опционально)
- **Тип:** `string`
- **Описание:** Символ токена (например, "SOL", "BTC")
- **Пример:** `?token=SOL`
- **Если не указан:** Возвращаются данные для всех токенов

#### `network` (опционально)
- **Тип:** `string`
- **Описание:** Идентификатор сети (например, "solana", "bsc")
- **Пример:** `?network=solana`
- **Если не указан:** Возвращаются данные для всех сетей

### Формат ответа

**Content-Type:** `application/json`

**Структура:** Массив объектов `StraightData`

```json
[
  {
    "token": "SOL",
    "aExchange": "Jupiter",
    "bExchange": "MEXC",
    "priceA": "62.12345678",
    "priceB": "62.40000000",
    "spread": "0.44",
    "network": "solana",
    "limit": "all"
  }
]
```

### Схема данных: `StraightData`

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `token` | `string` | Символ токена | `"SOL"` |
| `aExchange` | `string` | Первая биржа (источник) | `"Jupiter"` |
| `bExchange` | `string` | Вторая биржа (назначение) | `"MEXC"` |
| `priceA` | `string` | Цена на первой бирже | `"62.12345678"` |
| `priceB` | `string` | Цена на второй бирже | `"62.40000000"` |
| `spread` | `string` | **Уже рассчитанный спред** (в процентах) | `"0.44"` |
| `network` | `string` | Сеть блокчейна | `"solana"` |
| `limit` | `string` | Лимит (всегда "all"?) | `"all"` |

### Важные выводы для исправления проблем

#### ✅ Что правильно в текущей реализации:

1. **WebSocket как request-response** - **ПРАВИЛЬНО!** 
   - API не поддерживает persistent соединение
   - Нужно переподключаться для новых данных
   - Текущая реализация корректна

2. **Игнорирование `timeframe`** - **ПРАВИЛЬНО!**
   - API не поддерживает параметр `timeframe`
   - Проблема [Этап 3.1] - это не баг, а отсутствие поддержки на бэкенде

3. **`reverseSpread` всегда null** - **ПРАВИЛЬНО!**
   - API возвращает только straight spread (aExchange -> bExchange)
   - Нет отдельного endpoint для reverse spread
   - Проблема [Этап 3.2] - это не баг, а отсутствие функциональности на бэкенде

#### ⚠️ Что нужно исправить:

1. **Автоматическое переподключение** - **НУЖНО!**
   - Для получения новых данных нужно периодически переподключаться
   - Проблема [Этап 2.7] - актуальна, но не для persistent соединения, а для периодических переподключений

2. **WebSocket менеджер** - **ЖЕЛАТЕЛЬНО!**
   - Можно создать менеджер для управления переподключениями
   - Но не для persistent соединения, а для управления пулом переподключений

3. **Heartbeat/ping-pong** - **НЕ НУЖНО!**
   - Соединение закрывается сразу после отправки данных
   - Heartbeat не имеет смысла
   - Проблема [Этап 2.8] - не актуальна для этого типа WebSocket

### Формула расчета спреда

**Спред уже рассчитан на бэкенде** и приходит в поле `spread`.

Но для понимания, формула:
```
spread = ((priceB - priceA) / priceA) * 100
```

Где:
- `priceA` - цена на первой бирже (aExchange)
- `priceB` - цена на второй бирже (bExchange)
- Результат в процентах

### Примеры использования

#### Получить все спреды:
```
ws://158.220.122.153:8080/socket/sharkStraight
```

#### Получить спреды только для SOL:
```
ws://158.220.122.153:8080/socket/sharkStraight?token=SOL
```

#### Получить спреды для SOL на Solana:
```
ws://158.220.122.153:8080/socket/sharkStraight?token=SOL&network=solana
```

### HTTP Fallback

Если WebSocket handshake не удался, сервер возвращает HTTP 200 с JSON payload (тот же формат данных).

---

## Выводы для TODO.md

### Проблемы, которые НЕ являются багами:

1. **[Этап 2.6] WebSocket используется как request-response** - ✅ **ПРАВИЛЬНО!** API так и работает
2. **[Этап 3.1] getSpreadData игнорирует timeframe** - ✅ **ПРАВИЛЬНО!** API не поддерживает timeframe
3. **[Этап 3.2] reverseSpread всегда null** - ✅ **ПРАВИЛЬНО!** API не возвращает reverse spread

### Проблемы, которые нужно переформулировать:

1. **[Этап 2.7] Нет автоматического переподключения** - нужно периодическое переподключение для обновления данных
2. **[Этап 2.8] Нет heartbeat/ping-pong** - не актуально, соединение закрывается сразу
3. **[Этап 2.5] WebSocket создается каждый раз заново** - это правильно для этого типа API, но можно оптимизировать переподключения

### Что нужно исправить:

1. ✅ Утечки памяти - актуально
2. ✅ Баги в обработке ошибок - актуально
3. ✅ Оптимизация переподключений - можно улучшить
4. ✅ Документация - добавить информацию о том, что это не persistent WebSocket

